2.1

create table author 
(author_id INT PRIMARY KEY AUTO_INCREMENT ,
name_author VARCHAR(50))


insert into author (name_author  )
VALUES
('Булгаков М.А.'),
('Достоевский Ф.М.'),
('Есенин С.А.'),
('Пастернак Б.Л.')
;
Select * from author


CREATE TABLE book (
    book_id INT PRIMARY KEY AUTO_INCREMENT, 
    title VARCHAR(50), 
    author_id INT NOT NULL, 
    genre_id INT ,
    price DECIMAL(8,2), 
    amount INT, 
    FOREIGN KEY (author_id)  REFERENCES author (author_id) ,
     FOREIGN KEY (genre_id)  REFERENCES genre (genre_id) 
);



CREATE TABLE book (
    book_id INT PRIMARY KEY AUTO_INCREMENT, 
    title VARCHAR(50), 
    author_id INT NOT NULL, 
    genre_id INT ,
    price DECIMAL(8,2), 
    amount INT, 
    FOREIGN KEY (author_id)  REFERENCES author (author_id) ON DELETE CASCADE ,
     FOREIGN KEY (genre_id)  REFERENCES genre (genre_id) ON DELETE SET NULL
);


2.2
SELECT title, name_genre, price
FROM 
    book INNER JOIN genre
    ON book.genre_id = genre.genre_id
    WHERE amount >8
    ORDER BY price DESC
    
    
select  name_genre  from book right join genre ON book.genre_id=genre.genre_id
WHERE book_id is null


select name_city, name_author,  DATE_ADD('2020-01-01', INTERVAL FLOOR(RAND() * 365) DAY) as Дата  from city CROSS JOIN author 
ORDER BY name_city, Дата DESC


select name_genre,title,name_author from genre inner join book ON genre.genre_id =book.genre_id INNER JOIN author ON book.author_id=author.author_id 
WHERE name_genre LIKE "роман"
ORDER BY title



select name_author, SUM(amount) AS Количество from book AS b RIGHT JOIN author AS a ON b.author_id =a.author_id GROUP BY name_author
HAVING Количество <10 OR Количество IS NULL
ORDER BY Количество; 


select DISTINCT name_author /*,  count(DISTINCT genre_id) */ 
from book AS b  JOIN author AS a ON b.author_id =a.author_id
GROUP BY name_author
HAVING count(DISTINCT genre_id)=1


SELECT title, name_author, name_genre, price, amount
FROM 
    author 
    INNER JOIN book ON author.author_id = book.author_id
    INNER JOIN genre ON  book.genre_id = genre.genre_id
WHERE genre.genre_id in 
        (select genre_id
        from book
        group by genre_id
        having  sum(amount) = (
            select sum(amount) as sum_amount
            from book
            group by genre_id
            having sum_amount
            limit 1))
ORDER BY title

2.3

UPDATE book AS b JOIN author ON b.author_id=author.author_id 
JOIN supply AS s ON b.title=s.title
SET b.amount=b.amount + s.amount,
b.price =(b.price * b.amount + s.price * s.amount)/(b.amount + s.amount),
s.amount = 0
WHERE s.price != b.price AND author.name_author=s.author;
SELECT * FROM book;
SELECT * FROM supply;



/*select *  from author AS a RIGHT JOIN  supply AS s ON a.name_author=s.author;
*/INSERT INTO author (author_id , name_author )

select  supply_id, author  from author AS a RIGHT JOIN  supply AS s ON a.name_author=s.author
WHERE name_author IS NULL;
select * from author


INSERT INTO book ( title ,author_id ,price, amount )
SELECT title, author_id, price, amount
FROM 
    author 
    INNER JOIN supply ON author.name_author = supply.author
WHERE amount <> 0;
select * from book


UPDATE book 
SET genre_id= (select genre_id from genre WHERE genre_id=2)
WHERE book_id=10;
UPDATE book 
SET genre_id= (select genre_id from genre WHERE genre_id=3)
WHERE book_id=11;
select * from book


DELETE FROM author
WHERE author_id IN( 
            SELECT author_id 
            FROM book
            GROUP BY author_id
            HAVING SUM(amount) <= 20
            );
SELECT * FROM author;
SELECT * FROM book;


DELETE FROM genre
WHERE genre_id IN (select genre_id  from book GROUP BY genre_id HAVING COUNT(genre_id)<4);
SELECT * FROM genre;
SELECT * FROM book;



DELETE FROM author
USING 
     author 
     INNER JOIN book ON author.author_id = book.author_id
     INNER JOIN genre ON genre.genre_id = book.genre_id     
WHERE name_genre = 'Поэзия';
SELECT * FROM author;
SELECT * FROM book;
